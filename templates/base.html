<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}تعلم لغة الإشارة{% endblock %}</title>

    <!-- Bootstrap RTL CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- PWA Tags -->
    <link rel="manifest" href="{{ url_for('static', filename='pwa/manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='pwa/icon-192x192.png') }}">
    <meta name="theme-color" content="#000000">

    <!-- تحسين العرض على الجوال -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body class="d-flex flex-column min-vh-100">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">لغة الإشارة</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="تبديل التنقل">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <span class="nav-link">مرحباً، {{ current_user.username }}!</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('profile') }}">ملفي</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('chat') }}">💬 شات</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}">تسجيل خروج</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('home') }}">الرئيسية</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('about') }}">من نحن</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('chat') }}">💬 شات</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">دخول</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('register') }}">تسجيل</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show text-end" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="إغلاق"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Page Content -->
    <main class="container flex-grow-1 py-4 text-end">
        {% block content %}{% endblock %}
    </main>

    <!-- زر التثبيت (PWA Install Prompt) -->
    <button id="installBtn" class="btn btn-success d-none position-fixed bottom-0 start-50 translate-middle-x m-3"
            style="z-index: 1000; border-radius: 8px; padding: 12px 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        ثبت التطبيق 📲
    </button>

    <!-- Service Worker Registration -->
    <script>
        let deferredPrompt;

        // تسجيل Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/pwa/service-worker.js')
                    .then(reg => {
                        console.log('✅ SW مسجل:', reg.scope);
                    })
                    .catch(err => {
                        console.log('❌ فشل تسجيل SW:', err);
                    });
            });
        }

        // التقاط حدث التثبيت
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('🎉 beforeinstallprompt تم إرساله');
            e.preventDefault();
            deferredPrompt = e; // حفظ الحدث
            document.getElementById('installBtn').classList.remove('d-none'); // إظهار الزر الموجود
        });

        // تفعيل التثبيت عند الضغط على الزر
        document.getElementById('installBtn')?.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt(); // عرض نافذة التثبيت
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('✅ تم قبول التثبيت');
                    } else {
                        console.log('❌ تم رفض التثبيت');
                    }
                    deferredPrompt = null; // إفراغ المتغير
                    document.getElementById('installBtn').classList.add('d-none'); // إخفاء الزر
                });
            }
        });
    </script>

    <!-- Footer -->
    <footer class="footer bg-light text-center py-3 mt-5">
        <div class="container">
            <small>&copy; 2025 - تعلم لغة الإشارة. جميع الحقوق محفوظة.</small>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/install.js') }}"></script>
    <script src="{{ url_for('static', filename='js/camera.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="/static/js/install.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>