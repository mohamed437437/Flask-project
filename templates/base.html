<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ØªØ¹Ù„Ù… Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©{% endblock %}</title>

    <!-- Bootstrap RTL CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- PWA Tags -->
    <link rel="manifest" href="{{ url_for('static', filename='pwa/manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='pwa/icon-192x192.png') }}">
    <meta name="theme-color" content="#000000">

    <!-- ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body class="d-flex flex-column min-vh-100">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªÙ†Ù‚Ù„">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if current_user.is_authenticated %}
                        <li class="nav-item">
                            <span class="nav-link">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {{ current_user.username }}!</span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('profile') }}">Ù…Ù„ÙÙŠ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('chat') }}">ğŸ’¬ Ø´Ø§Øª</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('logout') }}">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('home') }}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('about') }}">Ù…Ù† Ù†Ø­Ù†</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('chat') }}">ğŸ’¬ Ø´Ø§Øª</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('login') }}">Ø¯Ø®ÙˆÙ„</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('register') }}">ØªØ³Ø¬ÙŠÙ„</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'danger' else 'warning' if category == 'warning' else 'info' }} alert-dismissible fade show text-end" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Page Content -->
    <main class="container flex-grow-1 py-4 text-end">
        {% block content %}{% endblock %}
    </main>

    <!-- Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª (PWA Install Prompt) -->
    <button id="installBtn" class="btn btn-success d-none position-fixed bottom-0 start-50 translate-middle-x m-3"
            style="z-index: 1000; border-radius: 8px; padding: 12px 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        Ø«Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“²
    </button>

    <!-- Service Worker Registration -->
    <script>
        let deferredPrompt;

        // ØªØ³Ø¬ÙŠÙ„ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/pwa/service-worker.js')
                    .then(reg => {
                        console.log('âœ… SW Ù…Ø³Ø¬Ù„:', reg.scope);
                    })
                    .catch(err => {
                        console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ SW:', err);
                    });
            });
        }

        // Ø§Ù„ØªÙ‚Ø§Ø· Ø­Ø¯Ø« Ø§Ù„ØªØ«Ø¨ÙŠØª
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ‰ beforeinstallprompt ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡');
            e.preventDefault();
            deferredPrompt = e; // Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø«
            document.getElementById('installBtn').classList.remove('d-none'); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
        });

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        document.getElementById('installBtn')?.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt(); // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª');
                    } else {
                        console.log('âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„ØªØ«Ø¨ÙŠØª');
                    }
                    deferredPrompt = null; // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù…ØªØºÙŠØ±
                    document.getElementById('installBtn').classList.add('d-none'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø±
                });
            }
        });
    </script>

    <!-- Footer -->
    <footer class="footer bg-light text-center py-3 mt-5">
        <div class="container">
            <small>&copy; 2025 - ØªØ¹Ù„Ù… Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</small>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/install.js') }}"></script>
    <script src="{{ url_for('static', filename='js/camera.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="/static/js/install.js"></script>
    <script src="/static/js/main.js"></script>
</body>
</html>