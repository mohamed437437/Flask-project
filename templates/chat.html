{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4">ğŸ’¬ Ø´Ø§Øª Ù„ØºØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠ</h2>
    <p class="text-center text-muted mb-4">Ø£Ø¯Ø®Ù„ Ù†ØµØŒ Ø£Ùˆ Ø³Ø¬Ù‘Ù„ ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ ØµÙˆØª â€” ÙˆØ³Ù†ÙˆÙØ± Ù„Ùƒ Ø§Ù„Ø¥Ø´Ø§Ø±Ø©</p>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª -->
    <ul class="nav nav-tabs mb-3" id="inputTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text" type="button">
                ğŸ“ Ù†Øµ
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="voice-tab" data-bs-toggle="tab" data-bs-target="#voice" type="button">
                ğŸ™ï¸ ØµÙˆØª
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="camera-tab" data-bs-toggle="tab" data-bs-target="#camera" type="button">
                ğŸ¥ ÙÙŠØ¯ÙŠÙˆ
            </button>
        </li>
    </ul>

    <div class="tab-content" id="inputTabsContent">
        <!-- Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ -->
        <div class="tab-pane fade show active" id="text" role="tabpanel">
            <div class="d-flex mb-3">
                <input type="text" id="textInput" class="form-control me-2" placeholder="Ø§ÙƒØªØ¨ Ø¬Ù…Ù„Ø© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ" dir="auto">
                <button onclick="processText()" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>

        <!-- ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª -->
        <div class="tab-pane fade" id="voice" role="tabpanel">
            <div class="text-center mb-3">
                <button id="startVoiceBtn" class="btn btn-secondary" onclick="startVoice()">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ
                </button>
                <button id="stopVoiceBtn" class="btn btn-danger d-none" onclick="stopVoice()">
                    Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                </button>
            </div>
            <div class="alert alert-info d-none" id="voiceStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</div>
        </div>

        <!-- ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ -->
        <div class="tab-pane fade" id="camera" role="tabpanel">
            <div class="text-center mb-3">
                <button id="startCameraBtn" class="btn btn-success" onclick="startCamera()">
                    Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button id="stopCameraBtn" class="btn btn-danger d-none" onclick="stopCamera()">
                    Ø¥ÙŠÙ‚Ø§Ù
                </button>
            </div>
            <div class="text-center mb-3">
                <video id="video" width="320" height="240" autoplay class="border rounded" style="max-width: 100%;"></video>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ø§Øª -->
    <div id="chatBox" class="border rounded p-3 bg-light" style="height: 400px; overflow-y: auto;">
        <div class="text-center text-muted">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</div>
    </div>
</div>

<script>
// --- ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ---
document.addEventListener('DOMContentLoaded', function () {
    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ---
    let mediaRecorder;
    let audioChunks = [];
    let videoStream = null;
    let captureInterval = null;
    const synth = window.speechSynthesis;

    // --- 1. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Øµ ---
    window.processText = function () {
        const input = document.getElementById('textInput');
        const text = input?.value.trim();
        if (!text) return;
        processInput(text);
        if (input) input.value = '';
    };

    // --- 2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª ---
    window.startVoice = async function () {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudioToAI(audioBlob);
            };

            mediaRecorder.start();
            const startBtn = document.getElementById('startVoiceBtn');
            const stopBtn = document.getElementById('stopVoiceBtn');
            const status = document.getElementById('voiceStatus');

            if (startBtn) startBtn.classList.add('d-none');
            if (stopBtn) stopBtn.classList.remove('d-none');
            if (status) status.classList.remove('d-none');
        } catch (err) {
            alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + (err.message || "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª"));
        }
    };

    window.stopVoice = function () {
        if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
        }
        const tracks = mediaRecorder?.stream?.getTracks() || [];
        tracks.forEach(track => track.stop());

        const startBtn = document.getElementById('startVoiceBtn');
        const stopBtn = document.getElementById('stopVoiceBtn');
        const status = document.getElementById('voiceStatus');

        if (startBtn) startBtn.classList.remove('d-none');
        if (stopBtn) stopBtn.classList.add('d-none');
        if (status) status.classList.add('d-none');
    };

    function sendAudioToAI(audioBlob) {
        const reader = new FileReader();
        reader.onload = function() {
            fetch('/api/ai-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ audio: reader.result })
            })
            .then(res => res.json())
            .then(data => {
                if (data.text) {
                    processInput(data.text);
                }
            })
            .catch(() => {
                processInput("ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØª.");
            });
        };
        reader.readAsDataURL(audioBlob);
    }

    // --- 3. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ---
    window.startCamera = async function () {
        const startBtn = document.getElementById('startCameraBtn');
        const stopBtn = document.getElementById('stopCameraBtn');
        const video = document.getElementById('video');

        if (!startBtn || !stopBtn || !video) {
            console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
            alert("Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±");
            return;
        }

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            videoStream = stream;

            // Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚
            video.onloadeddata = () => {
                console.log("Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±Ø³Ù…");
            };

            startBtn.classList.add('d-none');
            stopBtn.classList.remove('d-none');

            if (captureInterval) clearInterval(captureInterval);
            captureInterval = setInterval(captureAndSendFrame, 2000);
        } catch (err) {
            alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
        }
    };

    window.stopCamera = function () {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            const video = document.getElementById('video');
            if (video) video.srcObject = null;
            videoStream = null;
        }
        if (captureInterval) {
            clearInterval(captureInterval);
            captureInterval = null;
        }

        const startBtn = document.getElementById('startCameraBtn');
        const stopBtn = document.getElementById('stopCameraBtn');

        if (startBtn) startBtn.classList.remove('d-none');
        if (stopBtn) stopBtn.classList.add('d-none');
    };

    function captureAndSendFrame() {
        const video = document.getElementById('video');
        if (!video || !video.srcObject || video.readyState < 2) {
            console.warn("Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯");
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = 224;
        canvas.height = 224;
        const ctx = canvas.getContext('2d');

        // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ (ØªØ¬Ù†Ø¨ Ø§Ù„Ø´ÙØ§ÙÙŠØ©)
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/jpeg');

        fetch('/api/ai-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        })
        .then(res => res.json())
        .then(data => {
            if (data.text) {
                processInput(data.text);
            }
        })
        .catch(() => {
            processInput("ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©.");
        });
    }

    // --- 4. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¯Ø®Ù„ (Ù†Øµ â†’ Ø¥Ø´Ø§Ø±Ø©) ---
    function processInput(text) {
        addMessage(text, 'user');
        readTextAloud(text);

        fetch('/api/ai-sign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
        .then(res => res.json())
        .then(data => {
            if (data.video_url) {
                showSignVideo(text, data.video_url);
            }
        })
        .catch(() => {
            addMessage("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¢Ù†.", 'system');
        });
    }

    // --- 5. Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ---
    function addMessage(text, sender) {
        const chatBox = document.getElementById('chatBox');
        if (!chatBox) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = sender === 'user' ? 'd-flex justify-content-end mb-2' : 'd-flex justify-content-start mb-2';

        const msg = document.createElement('div');
        msg.className = sender === 'user'
            ? 'bg-primary text-white rounded-pill px-3 py-2 d-inline-block'
            : 'bg-light text-dark rounded px-3 py-2 d-inline-block';
        msg.textContent = text;

        messageDiv.appendChild(msg);
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showSignVideo(label, videoUrl) {
        const chatBox = document.getElementById('chatBox');
        if (!chatBox) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'd-flex flex-column align-items-start mb-3';

        const labelSpan = document.createElement('small');
        labelSpan.className = 'text-muted mb-1';
        labelSpan.textContent = `Ø¥Ø´Ø§Ø±Ø©: ${label}`;
        messageDiv.appendChild(labelSpan);

        const video = document.createElement('video');
        video.src = videoUrl;
        video.controls = true;
        video.style.width = '220px';
        video.style.borderRadius = '8px';
        video.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';

        messageDiv.appendChild(video);
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- 6. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ ØµÙˆØªÙŠÙ‹Ø§ ---
    function readTextAloud(text) {
        if (synth.speaking) synth.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        utter.rate = 0.9;
        utter.pitch = 1;
        synth.speak(utter);
    }
});
</script>
{% endblock %}