{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h2 class="text-center mb-4">ğŸ¥ Ø­ÙˆÙ„ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ù†Øµ</h2>
    <p class="text-center text-muted mb-4">Ø§ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ‚Ù… Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© â€” Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</p>

    <!-- Ø²Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div class="text-center mb-3">
        <button id="startBtn" class="btn btn-success btn-lg" onclick="startCamera()">
            Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        </button>
        <button id="stopBtn" class="btn btn-danger btn-lg d-none" onclick="stopCamera()">
            Ø¥ÙŠÙ‚Ø§Ù
        </button>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
    <div class="text-center mb-4">
        <video id="video" width="320" height="240" autoplay class="border rounded" style="max-width: 100%;"></video>
    </div>

    <!-- Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ -->
    <div class="mb-4">
        <label><strong>Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙØ³ØªÙ†ØªØ¬:</strong></label>
        <div id="result" class="form-control" style="height: 100px; background: #f8f9fa;">
            Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© Ø¨Ø¹Ø¯...
        </div>
    </div>

    <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
    <div id="loading" class="text-center text-info d-none">
        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"> </script>
<script>
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const loadingDiv = document.getElementById('loading');

let stream = null;
let intervalId = null;

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
async function startCamera() {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        startBtn.classList.add('d-none');
        stopBtn.classList.remove('d-none');

        // ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ©ØŒ Ù†Ø±Ø³Ù„ Ø¥Ø·Ø§Ø± Ù„Ù„ØªØ­Ù„ÙŠÙ„
        intervalId = setInterval(sendFrameForPrediction, 2000);
    } catch (err) {
        alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
    }
}

// Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
function stopCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.srcObject = null;
    }
    if (intervalId) clearInterval(intervalId);
    startBtn.classList.remove('d-none');
    stopBtn.classList.add('d-none');
    loadingDiv.classList.add('d-none');
}

// Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø·Ø§Ø± Ù„Ù„ØªØ­Ù„ÙŠÙ„
async function sendFrameForPrediction() {
    loadingDiv.classList.remove('d-none');

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø¥Ù„Ù‰ ØµÙˆØ±Ø©
    const canvas = document.createElement('canvas');
    canvas.width = 224;
    canvas.height = 224;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ base64
    const imageData = canvas.toDataURL('image/jpeg');

    try {
        const response = await fetch('/api/ai-text', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData })
        });

        const data = await response.json();
        if (data.text) {
            resultDiv.textContent = data.text;
        }
    } catch (err) {
        resultDiv.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.";
    } finally {
        loadingDiv.classList.add('d-none');
    }
}
</script>
{% endblock %}